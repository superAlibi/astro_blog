---
// 主题切换组件
---

<button
	id="theme-toggle"
	class="theme-toggle"
	aria-label="切换主题"
	title="切换主题"
>
	<!-- 太阳图标（亮色模式） -->
	<svg
		class="theme-icon theme-icon-light"
		xmlns="http://www.w3.org/2000/svg"
		viewBox="0 0 24 24"
		fill="none"
		stroke="currentColor"
		stroke-width="2"
		stroke-linecap="round"
		stroke-linejoin="round"
	>
		<circle cx="12" cy="12" r="5"></circle>
		<line x1="12" y1="1" x2="12" y2="3"></line>
		<line x1="12" y1="21" x2="12" y2="23"></line>
		<line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
		<line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
		<line x1="1" y1="12" x2="3" y2="12"></line>
		<line x1="21" y1="12" x2="23" y2="12"></line>
		<line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
		<line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
	</svg>
	<!-- 月亮图标（暗色模式） -->
	<svg
		class="theme-icon theme-icon-dark"
		xmlns="http://www.w3.org/2000/svg"
		viewBox="0 0 24 24"
		fill="none"
		stroke="currentColor"
		stroke-width="2"
		stroke-linecap="round"
		stroke-linejoin="round"
	>
		<path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
	</svg>
	<!-- 系统图标（自动模式） -->
	<svg
		class="theme-icon theme-icon-system"
		xmlns="http://www.w3.org/2000/svg"
		viewBox="0 0 24 24"
		fill="none"
		stroke="currentColor"
		stroke-width="2"
		stroke-linecap="round"
		stroke-linejoin="round"
	>
		<rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
		<line x1="8" y1="21" x2="16" y2="21"></line>
		<line x1="12" y1="17" x2="12" y2="21"></line>
	</svg>
</button>

<script>
	const THEME_STORAGE_KEY = "theme-preference";

	function getStoredTheme() {
		try {
			return localStorage.getItem(THEME_STORAGE_KEY) || "system";
		} catch {
			return "system";
		}
	}

	function getSystemTheme() {
		return window.matchMedia("(prefers-color-scheme: dark)").matches
			? "dark"
			: "light";
	}

	function setThemePreference(theme) {
		const root = document.documentElement;

		try {
			localStorage.setItem(THEME_STORAGE_KEY, theme);
		} catch {
			// 忽略存储错误
		}

		// 只需要设置 color-scheme，CSS 的 light-dark() 会自动处理
		if (theme === "system") {
			const systemTheme = getSystemTheme();
			root.style.colorScheme = systemTheme;
			root.setAttribute("data-theme", "system");
		} else {
			root.style.colorScheme = theme;
			root.setAttribute("data-theme", theme);
		}

		window.dispatchEvent(
			new CustomEvent("themechange", { detail: { theme } }),
		);
	}

	function getTheme() {
		return getStoredTheme();
	}

	const themeToggle = document.getElementById("theme-toggle");
	if (!themeToggle) {
		throw new Error("Theme toggle button not found");
	}

	// 更新按钮显示状态
	function updateToggleIcon() {
		const currentTheme = getTheme();

		// 移除所有活动状态
		themeToggle.classList.remove(
			"active-light",
			"active-dark",
			"active-system",
		);

		// 添加当前主题的活动状态
		if (currentTheme === "light") {
			themeToggle.classList.add("active-light");
		} else if (currentTheme === "dark") {
			themeToggle.classList.add("active-dark");
		} else {
			themeToggle.classList.add("active-system");
		}
	}

	// 切换主题
	function toggleTheme() {
		const currentTheme = getTheme();
		let nextTheme;

		// 循环切换：system -> light -> dark -> system
		if (currentTheme === "system") {
			nextTheme = "light";
		} else if (currentTheme === "light") {
			nextTheme = "dark";
		} else {
			nextTheme = "system";
		}

		setThemePreference(nextTheme);
		updateToggleIcon();
	}

	// 监听系统主题变化（仅在 system 模式下）
	function watchSystemTheme() {
		const mediaQuery = window.matchMedia("(prefers-color-scheme: dark)");
		const handleChange = () => {
			const storedTheme = getStoredTheme();
			if (storedTheme === "system" || !storedTheme) {
				setThemePreference("system");
			}
		};

		if (mediaQuery.addEventListener) {
			mediaQuery.addEventListener("change", handleChange);
		} else {
			mediaQuery.addListener(handleChange);
		}
	}

	// 绑定点击事件
	themeToggle.addEventListener("click", toggleTheme);

	// 监听主题变化事件
	window.addEventListener("themechange", updateToggleIcon);

	// 监听系统主题变化
	watchSystemTheme();

	// 初始化图标状态
	updateToggleIcon();
</script>

<style>
	.theme-toggle {
		display: flex;
		align-items: center;
		justify-content: center;
		width: 2.5rem;
		height: 2.5rem;
		padding: 0.5rem;
		background: transparent;
		border: 1px solid
			light-dark(rgba(96, 115, 159, 0.2), rgba(255, 255, 255, 0.2));
		border-radius: 0.5rem;
		cursor: pointer;
		transition: all 0.2s ease;
		color: var(--text-color-rgb);
		position: relative;
	}

	.theme-toggle:hover {
		background: light-dark(
			rgba(229, 233, 240, 0.5),
			rgba(255, 255, 255, 0.1)
		);
		border-color: light-dark(
			rgba(96, 115, 159, 0.4),
			rgba(255, 255, 255, 0.4)
		);
	}

	.theme-icon {
		width: 1.25rem;
		height: 1.25rem;
		position: absolute;
		opacity: 0;
		transform: scale(0.8);
		transition:
			opacity 0.2s ease,
			transform 0.2s ease;
	}

	.theme-icon-light {
		opacity: 0;
	}

	.theme-icon-dark {
		opacity: 0;
	}

	.theme-icon-system {
		opacity: 0;
	}

	/* 根据活动状态显示对应图标 */
	.theme-toggle.active-light .theme-icon-light {
		opacity: 1;
		transform: scale(1);
	}

	.theme-toggle.active-dark .theme-icon-dark {
		opacity: 1;
		transform: scale(1);
	}

	.theme-toggle.active-system .theme-icon-system {
		opacity: 1;
		transform: scale(1);
	}
</style>
